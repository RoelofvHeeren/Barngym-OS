// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ConnectionSecret {
  id             String   @id @default(cuid())
  provider       String   @unique
  secret         Json?
  webhookSecret  String?
  status         String?
  accountId      String?
  lastVerifiedAt DateTime?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Lead {
  id             String   @id @default(cuid())
  externalId     String?  @unique
  glofoxMemberId String?  @unique
  stripeCustomerId String?
  ghlContactId   String?  @unique
  firstName      String?
  lastName       String?
  email          String?
  phone          String?
  goal           String?
  source         String?
  gender         String?
  dateOfBirth    DateTime?
  street         String?
  city           String?
  state          String?
  country        String?
  zipCode        String?
  primaryMembershipPlan String?
  tags           Json?
  channel        String?
  stage          String?  @default("New")
  owner          String?
  nextStep       String?
  valueMinor     Int?
  membershipName String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  transactions   Transaction[]
  counterpartyMappings CounterpartyMapping[]
  leadTracking   LeadTracking[]
  leadEvents     LeadEvent[]

  @@index([email])
  @@index([phone])
  @@index([ghlContactId])
}

model Transaction {
  id           String   @id @default(cuid())
  provider     String
  externalId   String   @unique
  transactionUid String? @unique
  amountMinor  Int
  currency     String
  occurredAt   DateTime
  personName   String?
  productType  String?
  status       String
  confidence   String
  description  String?
  reference    String?
  raw          Json?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  leadId       String?
  lead         Lead?    @relation(fields: [leadId], references: [id])

  transactionType String?
  grossAmount     Float?
  feeAmount       Float?  @default(0)
  netAmount       Float?
  paymentMethod   String?
  membershipPlan  String?
  glofoxSaleId    String?
  stripeChargeId  String?
  starlingFeedItemId String?
  memberUid       String?
  externalAliases Json?
  notes           String?
  sourceFile      String?
  manualMatches   ManualMatchQueue[]

  @@index([occurredAt])
}

model RevenueGoal {
  id            String   @id @default(cuid())
  category      String   // e.g. "Total Revenue", "PT", "Classes", "Online", "Corporate", "Retreats", "Q1", etc.
  period        String   // "Yearly", "Quarterly", "Monthly"
  targetAmount  Float
  currentAmount Float    @default(0)
  progress      Float    @default(0)
  notes         String?
  createdAt     DateTime @default(now())
}

model SyncLog {
  id        String   @id @default(cuid())
  source    String
  detail    String
  records   String?
  errors    String?
  createdAt DateTime @default(now())
}

model ManualMatchQueue {
  id                 String   @id @default(cuid())
  transactionId      String
  reason             String
  suggestedMemberIds Json?
  createdAt          DateTime @default(now())
  resolvedAt         DateTime?
  resolvedBy         String?

  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model LeadTracking {
  id          String   @id @default(cuid())
  leadId      String
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  fbclid      String?
  gclid       String?
  formId      String?
  adId        String?
  campaignId  String?
  adsetId     String?
  platform    String?
  rawPayload  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id])

  @@index([leadId])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  eventType String
  payload   Json?
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([eventType])
}

model Goal {
  id          String   @id @default(cuid())
  name        String
  metric      String
  targetValue Float
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
}

model CounterpartyMapping {
  id        String   @id @default(cuid())
  provider  String
  key       String
  leadId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id])

  @@unique([provider, key])
}
