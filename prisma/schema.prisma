// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LeadStatus {
  LEAD
  CLIENT
}

model ConnectionSecret {
  id             String    @id @default(cuid())
  provider       String    @unique
  secret         Json?
  webhookSecret  String?
  status         String?
  accountId      String?
  lastVerifiedAt DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Lead {
  id                     String                @id @default(cuid())
  externalId             String?               @unique
  glofoxMemberId         String?               @unique
  stripeCustomerId       String?
  ghlContactId           String?               @unique
  fullName               String?
  firstName              String?
  lastName               String?
  email                  String?
  phone                  String?
  goal                   String?
  status                 LeadStatus?
  source                 String?
  isClient               Boolean               @default(false)
  gender                 String?
  dateOfBirth            DateTime?
  street                 String?
  city                   String?
  state                  String?
  country                String?
  zipCode                String?
  primaryMembershipPlan  String?
  tags                   Json?
  channel                String?
  stage                  String?               @default("New")
  owner                  String?
  companyName            String?
  pocName                String?
  pocEmail               String?
  employeeCount          Int?
  contractDuration       String?
  activities             Json?
  isCorporate            Boolean               @default(false)
  nextStep               String?
  valueMinor             Int?
  membershipName         String?
  metadata               Json?
  ltvAllCents            Int                   @default(0)
  ltvAdsCents            Int                   @default(0)
  ltvPTCents             Int                   @default(0)
  ltvClassesCents        Int                   @default(0)
  ltvSixWeekCents        Int                   @default(0)
  ltvOnlineCoachingCents Int                   @default(0)
  ltvCommunityCents      Int                   @default(0)
  ltvCorporateCents      Int                   @default(0)
  submissionDate         DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  transactions           Transaction[]
  payments               Payment[]
  adsRevenue             AdsRevenue[]
  counterpartyMappings   CounterpartyMapping[]
  leadTracking           LeadTracking[]
  leadEvents             LeadEvent[]

  @@index([email])
  @@index([phone])
  @@index([ghlContactId])
}

model Payment {
  id                String       @id @default(cuid())
  externalPaymentId String
  amountCents       Int
  currency          String
  timestamp         DateTime
  productName       String?
  productType       String?
  sourceSystem      String
  rawPayload        Json
  leadId            String?
  lead              Lead?        @relation(fields: [leadId], references: [id])
  adsRevenue        AdsRevenue[]
  createdAt         DateTime     @default(now())

  @@index([externalPaymentId, sourceSystem])
}

model AdsRevenue {
  id          String   @id @default(cuid())
  leadId      String
  paymentId   String
  amountCents Int
  timestamp   DateTime
  createdAt   DateTime @default(now())

  lead    Lead    @relation(fields: [leadId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([leadId])
  @@index([paymentId])
}

model AdsSpend {
  id          String   @id @default(cuid())
  periodStart DateTime
  periodEnd   DateTime
  amountCents Int
  currency    String   @default("GBP")
  source      String
  createdAt   DateTime @default(now())

  @@index([periodStart, periodEnd])
}

model MetaAdAccount {
  id        String             @id
  name      String?
  currency  String?
  timezone  String?
  insights  MetaDailyInsight[]
  campaigns MetaCampaign[]
  adsets    MetaAdSet[]
  ads       MetaAd[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model MetaCampaign {
  id        String             @id
  account   MetaAdAccount      @relation(fields: [accountId], references: [id])
  accountId String
  name      String?
  objective String?
  status    String?
  adsets    MetaAdSet[]
  ads       MetaAd[]
  insights  MetaDailyInsight[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model MetaAdSet {
  id               String             @id
  account          MetaAdAccount      @relation(fields: [accountId], references: [id])
  accountId        String
  campaign         MetaCampaign?      @relation(fields: [campaignId], references: [id])
  campaignId       String?
  name             String?
  status           String?
  optimizationGoal String?
  billingEvent     String?
  dailyBudget      Int?
  lifetimeBudget   Int?
  insights         MetaDailyInsight[]
  ads              MetaAd[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model MetaAd {
  id           String             @id
  account      MetaAdAccount      @relation(fields: [accountId], references: [id])
  accountId    String
  campaign     MetaCampaign?      @relation(fields: [campaignId], references: [id])
  campaignId   String?
  adset        MetaAdSet?         @relation(fields: [adsetId], references: [id])
  adsetId      String?
  name         String?
  status       String?
  creativeName String?
  insights     MetaDailyInsight[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model MetaDailyInsight {
  id          String        @id @default(cuid())
  account     MetaAdAccount @relation(fields: [accountId], references: [id])
  accountId   String
  campaign    MetaCampaign? @relation(fields: [campaignId], references: [id])
  campaignId  String?
  adset       MetaAdSet?    @relation(fields: [adsetId], references: [id])
  adsetId     String?
  ad          MetaAd?       @relation(fields: [adId], references: [id])
  adId        String?
  date        DateTime
  spend       Float         @default(0)
  impressions Int           @default(0)
  clicks      Int           @default(0)
  cpm         Float?
  cpc         Float?
  results     Int           @default(0)
  resultType  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([accountId, campaignId, adsetId, adId, date])
  @@index([accountId, date])
  @@index([campaignId, date])
  @@index([adsetId, date])
  @@index([adId, date])
}

model UnmatchedPayment {
  id                String   @id @default(cuid())
  externalPaymentId String
  sourceSystem      String
  customerEmail     String?
  customerPhone     String?
  reason            String?
  rawPayload        Json
  createdAt         DateTime @default(now())

  @@index([externalPaymentId, sourceSystem])
}

model Contact {
  id                String        @id @default(cuid())
  fullName          String?
  email             String?
  phone             String?
  status            String        @default("lead")
  sourceTags        String[]      @default([])
  segmentTags       String[]      @default([])
  isActive          Boolean       @default(false)
  firstSeenAt       DateTime?
  lastPaymentAt     DateTime?
  renewalDate       DateTime?
  membershipType    String?
  membershipEndDate DateTime?
  trainerizeId      String?
  ltvAllCents       Int           @default(0)
  ltvGlofoxCents    Int           @default(0)
  ltvStripeCents    Int           @default(0)
  ltvStarlingCents  Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  transactions      Transaction[]

  @@unique([email])
  @@index([phone])
}

model Transaction {
  contactId      String?
  contact        Contact? @relation(fields: [contactId], references: [id])
  id             String   @id @default(cuid())
  source         String
  provider       String
  externalId     String   @unique
  transactionUid String?  @unique
  amountMinor    Int
  currency       String
  occurredAt     DateTime
  personName     String?
  productType    String?
  status         String
  confidence     String
  description    String?
  reference      String?
  raw            Json?
  metadata       Json?
  tags           String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  leadId         String?
  lead           Lead?    @relation(fields: [leadId], references: [id])

  grossAmount        Float?
  feeAmount          Float?             @default(0)
  netAmount          Float?
  paymentMethod      String?
  membershipPlan     String?
  glofoxSaleId       String?
  stripeChargeId     String?
  starlingFeedItemId String?
  memberUid          String?
  externalAliases    Json?
  notes              String?
  sourceFile         String?
  manualMatches      ManualMatchQueue[]

  @@index([occurredAt])
}

model RevenueGoal {
  id            String   @id @default(cuid())
  category      String // e.g. "Total Revenue", "PT", "Classes", "Online", "Corporate", "Retreats", "Q1", etc.
  period        String // "Yearly", "Quarterly", "Monthly"
  targetAmount  Float
  currentAmount Float    @default(0)
  progress      Float    @default(0)
  notes         String?
  createdAt     DateTime @default(now())
}

model SyncLog {
  id        String   @id @default(cuid())
  source    String
  detail    String
  records   String?
  errors    String?
  createdAt DateTime @default(now())
}

model ManualMatchQueue {
  id                 String    @id @default(cuid())
  transactionId      String
  reason             String
  suggestedMemberIds Json?
  createdAt          DateTime  @default(now())
  resolvedAt         DateTime?
  resolvedBy         String?

  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model LeadTracking {
  id          String   @id @default(cuid())
  leadId      String
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  fbclid      String?
  gclid       String?
  formId      String?
  adId        String?
  campaignId  String?
  adsetId     String?
  platform    String?
  rawPayload  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id])

  @@index([leadId])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  eventType String
  payload   Json?
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([eventType])
}

model Goal {
  id          String   @id @default(cuid())
  name        String
  metric      String
  targetValue Float
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
}

model CounterpartyMapping {
  id        String   @id @default(cuid())
  provider  String
  key       String
  leadId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id])

  @@unique([provider, key])
}

model Member {
  id        String   @id @default(cuid())
  memberId  String   @unique // Glofox Member ID
  firstName String?
  lastName  String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  bookings    Booking[]
}

model Membership {
  id              String    @id @default(cuid())
  membershipId    String    @unique
  memberId        String
  member          Member    @relation(fields: [memberId], references: [memberId])
  status          String?
  name            String?
  startDate       DateTime?
  endDate         DateTime?
  price           Float?
  nextPaymentDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([memberId])
}

model Booking {
  id        String    @id @default(cuid())
  bookingId String    @unique
  memberId  String
  member    Member    @relation(fields: [memberId], references: [memberId])
  classType String?
  startTime DateTime?
  endTime   DateTime?
  paid      String? // Store as string "true"/"false" or whatever Glofox sends, or map to boolean
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([memberId])
}

model GlofoxGhlLink {
  id           String   @id @default(cuid())
  glofoxId     String   @unique
  ghlContactId String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// -- Content Dashboard Models --

enum VideoProjectStatus {
  IDEA
  SCRIPTING
  READY_TO_FILM
  FILMED
  EDITING
  FINAL_PRODUCT
}

enum VideoProjectPriority {
  LOW
  MEDIUM
  HIGH
}

enum VideoPlatform {
  INSTAGRAM_REEL
  TIKTOK
  YOUTUBE_SHORT
  YOUTUBE_LONG
  OTHER
}

model VideoProject {
  id              String               @id @default(cuid())
  title           String
  platform        VideoPlatform        @default(INSTAGRAM_REEL)
  status          VideoProjectStatus   @default(IDEA)
  priority        VideoProjectPriority @default(MEDIUM)
  
  // Script & Brief Data
  scriptContent   String?              @db.Text // Rich text or markdown
  editingBrief    Json?                // Structured brief data
  
  // Metadata
  goal            String?
  assignedCoach   String?
  assignedEditor  String?
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  assets          VideoAsset[]
}

enum VideoAssetType {
  RAW_FOOTAGE
  B_ROLL
  REFERENCE
  FINAL_EXPORT
  OTHER
}

model VideoAsset {
  id            String         @id @default(cuid())
  projectId     String
  type          VideoAssetType
  url           String
  filename      String
  mimeType      String?
  sizeBytes     Int?
  
  createdAt     DateTime       @default(now())
  
  project       VideoProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

model ContentTemplate {
  id            String   @id @default(cuid())
  name          String
  description   String?
  structure     Json     // JSON defining the script structure steps
  defaults      Json?    // Default values for brief etc
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
